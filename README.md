# CATCH-APIs v2.0.0

The Planetary Data System Small Bodies Node survey data search tool: catch comets and asteroids in wide-field sky survey data.

## Overview

CATCH-APIs provide a REST API service that enable a user to search for potential observations of comets and asteroids in wide-field sky survey data.  This API is designed for use by the Planetary Data System Small Bodies Node (SBN) at the University of Maryland, but it is possible to deploy anywhere with other data sets.  SBN is the primary archive for the Near-Earth Asteroid Tracking (NEAT) survey, the Asteroid Terrestrial-impact Last Alert System (ATLAS), the Catalina Sky Survey, and Spacewatch.  CATCH-APIs is one of the primary methods for users to discover scientifically interesting data in those data sets.

The API is backed by:

- The [catch](https://github.com/Small-Bodies-Node/catch) and [sbsearch](https://github.com/Small-Bodies-Node/sbsearch) Python libraries, which define how survey metadata is stored and execute the actual searches on the database.
  - The [s2geometry](http://s2geometry.io/) C++ library is used for spatial indexing on the Celestial Sphere.
  - Target ephemerides are generated by [Horizons](https://ssd.jpl.nasa.gov/horizons/) at NASA JPL via [astroquery](https://astroquery.readthedocs.io/).
  - [SQLAlchemy](https://www.sqlalchemy.org/) and [PostgreSQL](https://www.postgresql.org/) store user queries and survey metadata.
  - Metadata ingestion uses the [pds3](https://github.com/mkelley/pds3) or [pds4_tools](https://github.com/Small-Bodies-Node/pds4_tools) Python libraries.
- [flask](https://flask.palletsprojects.com/), [connexion](https://connexion.readthedocs.io/), [openapi](https://swagger.io/specification/), and [gunicorn](https://gunicorn.org/) for the API experience and documentation.
- [redis](https://redis.io/) for the job queue and user task messaging.
- [rq](https://python-rq.org/) and [pm2](https://pm2.keymetrics.io/) execute the job queue.

## Requirements

CATCH-APIs are developed for linux/macos systems.  Python requirements are detailed in [setup.cfg](setup.cfg).

## Setup

1. Create the database and setup user access:
   1. The user account that maintains the database (e.g., adds new observations), requires CREATE privileges on the database, and SELECT and INSERT privileges on all tables.
   2. The user account that owns the API instances will need SELECT privileges on all tables, and INSERT privileges on the obj, designation, catch_query, caught, and found tables.
2. Copy `.env-template` to `.env` and edit according to the comments.
3. The `_initial_setup.sh` script builds a virtual environment with all required libraries.  Using `bash`, source this file to run the script and load the new environment: `source _initial_setup.sh`.
4. Insert data into the database.  See the [catch README](https://github.com/Small-Bodies-Node/catch) for details.

## Usage

### Local instances for testing

1. Set the `DEPLOYMENT_TIER` in `.env` to `LOCAL`.
2. Open two terminal instances.  For each instance, enter the CATCH-APIs virtual environment: `source _activate`.
3. In the first terminal:
   1. Is redis running?  `bash _redis_manager status`.  If not, start up the redis queuing system: `bash _redis_manager start`.
   2. Start up worker processes: `bash _develop_workers`.
4. In the second terminal, start up the API server: `bash _develop_apis`.
5. Open the swagger documentation.  If the `BASE_URL` in `.env` is empty: http://localhost:5003/ui .

### Production

TBD
