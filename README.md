# CATCH-APIs v2.0.0

The Planetary Data System Small Bodies Node survey data search tool: catch comets and asteroids in wide-field sky survey data.

## Overview

CATCH-APIs provide a REST API service that enable a user to search for potential observations of comets and asteroids in wide-field sky survey data.  This API is designed for use by the Planetary Data System Small Bodies Node (SBN) at the University of Maryland, but it is possible to deploy anywhere with other data sets.  SBN is the primary archive for the Near-Earth Asteroid Tracking (NEAT) survey, the Asteroid Terrestrial-impact Last Alert System (ATLAS), the Catalina Sky Survey, and Spacewatch.  CATCH-APIs is one of the primary methods for users to discover scientifically interesting data in those data sets.

The API is backed by:

- The [catch](https://github.com/Small-Bodies-Node/catch) and [sbsearch](https://github.com/Small-Bodies-Node/sbsearch) Python libraries, which define how survey metadata is stored and execute the actual searches on the database.
  - The [s2geometry](http://s2geometry.io/) C++ library is used for spatial indexing on the Celestial Sphere.
  - Target ephemerides are generated by [Horizons](https://ssd.jpl.nasa.gov/horizons/) at NASA JPL via [astroquery](https://astroquery.readthedocs.io/).
  - [SQLAlchemy](https://www.sqlalchemy.org/) and [PostgreSQL](https://www.postgresql.org/) store user queries and survey metadata.
  - Metadata ingestion uses the [pds3](https://github.com/mkelley/pds3) or [pds4_tools](https://github.com/Small-Bodies-Node/pds4_tools) Python libraries.
- [flask](https://flask.palletsprojects.com/), [connexion](https://connexion.readthedocs.io/), [openapi](https://swagger.io/specification/), and [gunicorn](https://gunicorn.org/) for the API experience and documentation.
- [redis](https://redis.io/) for the job queue and user task messaging.
- [rq](https://python-rq.org/) and [pm2](https://pm2.keymetrics.io/) execute the job queue.

## Features
- A single observation table holds all observations from all surveys.  This feature allows for an approximate search that can ignore parallax and search all surveys in one go.  Fine for objects a few au a way or more.
- The S2 library cells are set to a minimum size of 3e-4 radians (about 1 arcmin), and maximum size of 10 deg.
- Ephemerides may create loops on the sky (e.g., during retrograde motion), this is correctly handled by S2, even when padding the ephemeris with some uncertainty.
- Ephemeris segments are combined into groups 10 degrees or 30 days long (whichever limit is reached first; 10 deg / 30 days = 50" / hour), and the database is queried for the combined line all at once.  This improves performance because the segments are spatially correlated.

## Setup

CATCH-APIs are developed for linux/macos systems.

### Requirements

- Python 3.7 or greater. Python module requirements are detailed in [setup.cfg](setup.cfg).
- CMake 3.12 or greater and a work gcc tool chain to build the S2 library.
- Postgresql 13

### Steps

1. Create the database, e.g., `createdb catch`.
2. Setup user access:
   1. The user account that maintains the database (e.g., adds new observations), requires CREATE privileges on the database, SELECT, INSERT, and UPDATE privileges on all tables, USAGE privileges on all sequences:

      ```sql
      GRANT CREATE ON DATABASE catch TO user;
      GRANT SELECT ON ALL TABLES IN SCHEMA public TO user;
      GRANT INSERT ON ALL TABLES IN SCHEMA public TO user;
      GRANT UPDATE ON ALL TABLES IN SCHEMA public TO user;
      GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO user;
      ```

   2. The user account that owns the API instances will need SELECT privileges on all tables, and INSERT and UPDATE privileges on select tables, and USAGE privileges on select sequences:

      ```sql
      GRANT SELECT ON ALL TABLES IN SCHEMA public TO user;
      GRANT INSERT ON catch_query,designation,found,obj,orbit TO user;
      GRANT UPDATE ON catch_query TO user;
      GRANT USAGE ON catch_query_query_id_seq,designation_desg_id_seq,found_found_id_seq,obj_object_id_seq,orbit_orbit_id_seq TO user;
      ```

3. (Optional) Restore previous database snapshot: `pg_restore --clean --if-exists -d catch catch.backup`.
4. Copy `.env-template` to `.env` and edit according to the comments.
5. The `_initial_setup` script builds a virtual environment with all required libraries.  Using `bash`, source this file to run the script and load the new environment: `source _initial_setup`.
6. If no data was restored in step 3, insert new survey metadata into the database.  See the [catch README](https://github.com/Small-Bodies-Node/catch) for details.

## Usage

### Local instances for testing

1. Set the `DEPLOYMENT_TIER` in `.env` to `LOCAL`.
2. Open two terminal instances.  For each instance, enter the CATCH-APIs virtual environment: `source _activate`.
3. In the first terminal:
   1. Is redis running?  `bash _redis_manager status`.  If not, start up the redis queuing system: `bash _redis_manager start`.
   2. Start up worker processes: `bash _develop_workers`.
4. In the second terminal, start up the API server: `bash _develop_apis`.
5. Open the swagger documentation.  If the `BASE_URL` in `.env` is empty: http://localhost:5003/ui .

### Production

TBD
