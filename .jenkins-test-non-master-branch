
pipeline {

    agent any
    triggers {
    GenericTrigger(
            genericVariables: [
                // [key: 'blah', value: '$'],
                [key: 'ref', value: '$.pull_request.head.ref'],
                [key: 'clone_url', value: '$.repository.clone_url']
            ],

            // causeString: 'Triggered on $blah',

            token: 'abc123',

            printContributedVariables: true,
            printPostContent: true,

            silentResponse: false,

            // regexpFilterText: '$ref',
            // regexpFilterExpression: 'refs/heads/' + BRANCH_NAME
        )
    }

    stages {
        stage('Build') {
            steps {
                echo 'Building...'
                // checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/dwd-umd/catch-apis.git']]])
                echo ">>>>>>>"

                sh '''
                    echo "@@@@@@@  "
                    echo $ref
                    echo "******* "
                '''


                sh '''
                    cat .jenkins-temp
                '''
            }
        }
        stage('Test') {
            steps {
                echo 'Testing...'
                sh '''
                    # Generate unit-test report
                    sh _run_tests.sh                        # Add 'fail' to fail
                '''
                junit 'pytest_unit.xml'
            }
        }

        stage('Merge') {
            steps {
                echo 'Merging...'

                def patchOrg = """
                        {
                            "base": "master",
                            "head": $ref,
                            "commit_message": "Shipped cool_feature!"
                        }
                    """

                def response = httpRequest authentication: 'github-up-id' acceptType: 'APPLICATION_JSON', contentType: 'APPLICATION_JSON', httpMode: 'PATCH', requestBody: patchOrg, url: "https://api.github.com/repos/dwd-umd/catch-apis/merges"

                sh '''
                    echo "+++++++++++"
                '''
            }
        }
    }
}