/*
 *  This script will be triggered by the Generic Webhook Trigger Plugin
 *  when a github pull-request is closed and we want to automatically
 *  update and restart the production API on Oort
 */

pipeline {

    agent any

    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'action', value: '$.action', regexpFilter: 'closed'], //Only run this build when the action field has value 'closed'
                [key: 'everything', value: '$']
                // [key: 'ref', value: '$.pull_request.head.ref'],
                // [key: 'clone_url', value: '$.pull_request.head.repo.clone_url']
            ],

            // The token is required both in this script AND in the Jenkins pipeline GUI
            token: env.GENERIC_WEBHOOK_TOKEN,  //Defined as global var

            causeString: 'Triggered on $action equalling "closed"',
            printContributedVariables: true,
            printPostContent: !true,
            silentResponse: false,
            regexpFilterText: '',
            regexpFilterExpression: ''
        )
    }

    stages {
        stage('Build') {
            steps {
                echo 'START BUILD ...'
                checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/dwd-umd/catch-apis.git']]])
                echo "... END BUILD"
            }
        }
        stage('Test') {
            steps {
                echo 'START TESTING ...'
                sh '''
                    sh _run_tests.sh                # Add argument 'fail' in order test failing
                '''
                junit 'pytest_unit.xml'
                echo "... END TESTING"
            }
        }
        stage('Deploy') {
            steps {
                echo "START DEPLOYING ..."
                sh '''
                    cd $CATCH_APIS_PATH     # Global env var (go to 'Manage Jenkins > Configure System > Global properties' and add vars)
                    git pull
                    . $CATCH_APIS_PATH/_initial_setup.sh jenkins

                    # Must set this env for daemon to survive pipeline's termination
                    #JENKINS_NODE_COOKIE=dontKillMe sh ./_start_prod_api.sh
                    JENKINS_NODE_COOKIE=dontKillMe sh ./_catch_production_apis.sh restart

                    #touch "hello-`date +%Y-%m-%d`.txt"
                    touch "hello-`date`.txt"

                    curl localhost:5001/catch/test
                    echo "... END DEPLOYING"
                '''
            }
        }
    }
}